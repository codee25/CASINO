<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–Ü–º–ø–µ—Ä—ñ—è –°–ª–æ—Ç–∞</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#6B46C1', // Example primary color
                        secondary: '#9F7AEA', // Example secondary color
                        darkblue: '#1A202C', // Dark background
                        darkgreen: '#1D401D', // Dark green for game areas
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* GitHub Dark default background */
            color: #e2e8f0; /* Light text for dark background */
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        .symbol-reel {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 80px;
            height: 80px;
            background-color: #2D3748; /* Darker gray for reels */
            border-radius: 10px;
            font-size: 3em; /* Larger symbols */
            animation: spin-blur 0.5s infinite linear; /* Animation for spinning effect */
        }
        .symbol-reel.stop {
            animation: none;
            filter: none;
        }
        @keyframes spin-blur {
            0% { filter: blur(0px); }
            50% { filter: blur(3px); }
            100% { filter: blur(0px); }
        }
        .blackjack-card {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 60px;
            height: 90px;
            background-color: white;
            color: black;
            border-radius: 8px;
            border: 1px solid #333;
            font-size: 1.2em;
            font-weight: bold;
            margin: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        .blackjack-card.hidden-card {
            background-color: #555;
            color: #eee;
            font-size: 1em;
        }
        .game-section {
            display: none; /* –ü—Ä–∏—Ö–æ–≤–∞–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
        }
        .game-section.active {
            display: block; /* –ü–æ–∫–∞–∑–∞–Ω–æ, —è–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∏–π */
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-darkblue min-h-screen p-4 flex flex-col items-center">
    <div class="container bg-gray-800 p-6 rounded-lg shadow-xl text-center flex flex-col gap-4">
        <h1 class="text-3xl font-bold text-yellow-400 mb-4">–Ü–ú–ü–ï–†–Ü–Ø –°–õ–û–¢–ê</h1>

        <!-- User Info Panel -->
        <div class="bg-gray-700 p-4 rounded-lg flex flex-col items-center gap-2">
            <div class="flex items-center gap-2">
                <img src="https://placehold.co/40x40/FFD700/000?text=C" alt="Coins Icon" class="rounded-full">
                <span class="text-xl font-semibold">–ë–ê–õ–ê–ù–°: <span id="userBalance" class="text-yellow-400">0</span> –§–ê–ù–¢–ò–ö–Ü–í</span>
            </div>
            <div class="flex items-center gap-4 text-lg">
                <span id="userLevel">–†–Ü–í–ï–ù–¨: 1</span>
                <div class="flex items-center gap-2">
                    <span>XP: <span id="userXP">0</span>/<span id="userNextLevelXP">100</span></span>
                    <div class="w-24 h-2 bg-gray-500 rounded-full overflow-hidden">
                        <div id="xpProgressBar" class="h-full bg-green-500 transition-all duration-300 ease-out" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            <button id="dailyBonusBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow">–©–æ–¥–µ–Ω–Ω–∞ –í–∏–Ω–∞–≥–æ—Ä–æ–¥–∞</button>
            <button id="quickBonusBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow mt-2">–®–≤–∏–¥–∫–∞ –í–∏–Ω–∞–≥–æ—Ä–æ–¥–∞</button>
            <p id="bonusMessage" class="text-sm text-green-300 mt-1"></p>
        </div>

        <!-- Game Navigation -->
        <div class="flex justify-around bg-gray-700 p-2 rounded-lg mt-4">
            <button class="game-nav-btn p-2 rounded-md transition-colors hover:bg-gray-600" data-game="slots">
                <img src="https://placehold.co/40x40/FF4500/FFF?text=777" alt="Slots Icon" class="mx-auto">
                <span class="text-sm">–°–ª–æ—Ç–∏</span>
            </button>
            <button class="game-nav-btn p-2 rounded-md transition-colors hover:bg-gray-600" data-game="coinflip">
                <img src="https://placehold.co/40x40/00FF00/FFF?text=Coin" alt="Coin Flip Icon" class="mx-auto">
                <span class="text-sm">–ú–æ–Ω–µ—Ç–∫–∞</span>
            </button>
            <button class="game-nav-btn p-2 rounded-md transition-colors hover:bg-gray-600" data-game="blackjack">
                <img src="https://placehold.co/40x40/0000FF/FFF?text=21" alt="Blackjack Icon" class="mx-auto">
                <span class="text-sm">–ë–ª–µ–∫–¥–∂–µ–∫</span>
            </button>
            <button class="game-nav-btn p-2 rounded-md transition-colors hover:bg-gray-600" data-game="leaderboard">
                <img src="https://placehold.co/40x40/FFA500/FFF?text=üèÜ" alt="Leaderboard Icon" class="mx-auto">
                <span class="text-sm">–õ—ñ–¥–µ—Ä–∏</span>
            </button>
        </div>

        <!-- Game Sections -->
        <div id="slots-section" class="game-section active mt-4 bg-gray-900 p-4 rounded-lg">
            <h2 class="text-2xl font-semibold text-yellow-300 mb-4">–°–ª–æ—Ç–∏ <span class="text-base text-gray-400"> (–°—Ç–∞–≤–∫–∞: 100)</span></h2>
            <div class="flex justify-center items-center gap-4 mb-6">
                <div id="reel1" class="symbol-reel">?</div>
                <div id="reel2" class="symbol-reel">?</div>
                <div id="reel3" class="symbol-reel">?</div>
            </div>
            <button id="spinButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow text-xl w-full">–ö–†–£–¢–ò–¢–ò!</button>
            <p id="slotMessage" class="text-xl mt-4 text-green-400"></p>
        </div>

        <div id="coinflip-section" class="game-section mt-4 bg-gray-900 p-4 rounded-lg">
            <h2 class="text-2xl font-semibold text-yellow-300 mb-4">–ü—ñ–¥–∫–∏–¥–∞–Ω–Ω—è –ú–æ–Ω–µ—Ç–∫–∏ <span class="text-base text-gray-400"> (–°—Ç–∞–≤–∫–∞: 50)</span></h2>
            <div class="flex justify-center items-center gap-4 mb-6">
                <img id="coinImage" src="https://placehold.co/100x100/FFD700/000?text=?" alt="Coin" class="rounded-full shadow-lg">
            </div>
            <div class="flex justify-center gap-4">
                <button id="headsButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow text-xl w-1/2">–û–†–ï–õ</button>
                <button id="tailsButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow text-xl w-1/2">–†–ï–®–ö–ê</button>
            </div>
            <p id="coinflipMessage" class="text-xl mt-4 text-green-400"></p>
        </div>

        <div id="blackjack-section" class="game-section mt-4 bg-gray-900 p-4 rounded-lg">
            <h2 class="text-2xl font-semibold text-yellow-300 mb-4">–ë–ª–µ–∫–¥–∂–µ–∫ <span class="text-base text-gray-400"> (–ú—É–ª—å—Ç–∏–ø–ª–µ—î—Ä)</span></h2>
            <div id="blackjackStatus" class="text-center text-lg mb-2">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>
            <div id="blackjackTimer" class="text-center text-xl text-yellow-400 mb-4 hidden">–ì—Ä–∞ –ø–æ—á–Ω–µ—Ç—å—Å—è —á–µ—Ä–µ–∑: <span id="timerCountdown"></span> —Å–µ–∫.</div>
            
            <div class="bg-darkgreen p-4 rounded-lg mb-4 shadow">
                <h3 class="text-xl font-bold text-gray-200 mb-2">–î–∏–ª–µ—Ä:</h3>
                <div id="dealerHand" class="flex flex-wrap justify-center mb-2">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</div>
                <p id="dealerScore" class="text-lg text-gray-300">–†–∞—Ö—É–Ω–æ–∫: 0</p>
            </div>

            <div id="blackjackPlayers" class="flex flex-col gap-4">
                <!-- Player cards will be injected here -->
                <p class="text-center text-lg text-gray-400" id="waitingForPlayersText">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤...</p>
            </div>

            <div id="blackjackControls" class="mt-4 flex flex-col gap-2">
                <input type="number" id="blackjackBetInput" placeholder="–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞" class="w-full p-2 rounded-md bg-gray-700 text-white border border-gray-600">
                <button id="blackjackBetBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow w-full">–ó—Ä–æ–±–∏—Ç–∏ —Å—Ç–∞–≤–∫—É</button>
                <div class="flex gap-2">
                    <button id="blackjackHitBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow flex-1">–í–∑—è—Ç–∏ —â–µ</button>
                    <button id="blackjackStandBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow flex-1">–ó—É–ø–∏–Ω–∏—Ç–∏—Å—å</button>
                </div>
            </div>
            <p id="blackjackMessage" class="text-xl mt-4 text-green-400"></p>
        </div>

        <div id="leaderboard-section" class="game-section mt-4 bg-gray-900 p-4 rounded-lg">
            <h2 class="text-2xl font-semibold text-yellow-300 mb-4">–î–æ—à–∫–∞ –õ—ñ–¥–µ—Ä—ñ–≤</h2>
            <div id="leaderboardList" class="space-y-2">
                <!-- Leaderboard entries will be loaded here -->
                <p class="text-center text-gray-400">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
            </div>
        </div>

        <p class="text-sm text-gray-500 mt-6">@Casinoslots2_bot</p>
    </div>

    <script>
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram WebApp
        Telegram.WebApp.ready();
        const userId = Telegram.WebApp.initDataUnsafe.user.id;
        const username = Telegram.WebApp.initDataUnsafe.user.username || Telegram.WebApp.initDataUnsafe.user.first_name || `–ì—Ä–∞–≤–µ—Ü—å ${String(userId).slice(-4)}`;

        // =========================================================
        // –í–ê–ñ–õ–ò–í–û: –ù–∞–ª–∞—à—Ç—É–π—Ç–µ —Ü–µ–π URL –¥–ª—è –≤–∞—à–æ–≥–æ –±–µ–∫–µ–Ω–¥—É –Ω–∞ Render.com
        // –ó–∞–º—ñ–Ω—ñ—Ç—å 'YOUR_RENDER_BACKEND_HOSTNAME' –Ω–∞ –¥–æ–º–µ–Ω –≤–∞—à–æ–≥–æ Render Web Service
        // –ù–∞–ø—Ä–∏–∫–ª–∞–¥: 'casino-0h0l.onrender.com'
        const BACKEND_HOSTNAME = 'YOUR_RENDER_BACKEND_HOSTNAME'; 
        // =========================================================

        const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const API_BASE_URL = `${protocol}//${BACKEND_HOSTNAME}/api`;
        const WS_BASE_URL = `${wsProtocol}//${BACKEND_HOSTNAME}/ws`;

        // UI –ï–ª–µ–º–µ–Ω—Ç–∏
        const userBalanceSpan = document.getElementById('userBalance');
        const userXPSpan = document.getElementById('userXP');
        const userLevelSpan = document.getElementById('userLevel');
        const userNextLevelXPSpan = document.getElementById('userNextLevelXP');
        const xpProgressBar = document.getElementById('xpProgressBar');
        const dailyBonusBtn = document.getElementById('dailyBonusBtn');
        const quickBonusBtn = document.getElementById('quickBonusBtn');
        const bonusMessage = document.getElementById('bonusMessage');

        const gameNavButtons = document.querySelectorAll('.game-nav-btn');
        const gameSections = document.querySelectorAll('.game-section');

        // –°–ª–æ—Ç–∏
        const reel1 = document.getElementById('reel1');
        const reel2 = document.getElementById('reel2');
        const reel3 = document.getElementById('reel3');
        const spinButton = document.getElementById('spinButton');
        const slotMessage = document.getElementById('slotMessage');

        // –ú–æ–Ω–µ—Ç–∫–∞
        const coinImage = document.getElementById('coinImage');
        const headsButton = document.getElementById('headsButton');
        const tailsButton = document.getElementById('tailsButton');
        const coinflipMessage = document.getElementById('coinflipMessage');

        // –ë–ª–µ–∫–¥–∂–µ–∫
        const blackjackStatus = document.getElementById('blackjackStatus');
        const blackjackTimer = document.getElementById('blackjackTimer');
        const timerCountdown = document.getElementById('timerCountdown');
        const dealerHandDiv = document.getElementById('dealerHand');
        const dealerScoreP = document.getElementById('dealerScore');
        const blackjackPlayersDiv = document.getElementById('blackjackPlayers');
        const waitingForPlayersText = document.getElementById('waitingForPlayersText');
        const blackjackBetInput = document.getElementById('blackjackBetInput');
        const blackjackBetBtn = document.getElementById('blackjackBetBtn');
        const blackjackHitBtn = document.getElementById('blackjackHitBtn');
        const blackjackStandBtn = document.getElementById('blackjackStandBtn');
        const blackjackMessage = document.getElementById('blackjackMessage');
        let blackjackSocket = null;
        let currentRoomId = null;

        // –õ—ñ–¥–µ—Ä–±–æ—Ä–¥
        const leaderboardList = document.getElementById('leaderboardList');

        // --- –ó–∞–≥–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó UI ---
        function updateUserInfo(data) {
            userBalanceSpan.textContent = data.balance;
            userXPSpan.textContent = data.xp;
            userLevelSpan.textContent = `–†–Ü–í–ï–ù–¨: ${data.level}`;
            userNextLevelXPSpan.textContent = data.next_level_xp;
            const xpPercentage = (data.xp / data.next_level_xp) * 100;
            xpProgressBar.style.width = `${Math.min(xpPercentage, 100)}%`; // –û–±–º–µ–∂—É—î–º–æ 100%

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞–π–º–µ—Ä—ñ–≤ –±–æ–Ω—É—Å—ñ–≤
            updateBonusButton(dailyBonusBtn, data.last_daily_bonus_claim, 24 * 60 * 60, "–©–æ–¥–µ–Ω–Ω–∞ –í–∏–Ω–∞–≥–æ—Ä–æ–¥–∞");
            updateBonusButton(quickBonusBtn, data.last_quick_bonus_claim, 15 * 60, "–®–≤–∏–¥–∫–∞ –í–∏–Ω–∞–≥–æ—Ä–æ–¥–∞");
        }

        function updateBonusButton(button, lastClaim, cooldownSeconds, buttonText) {
            const now = Date.now();
            let lastClaimTime = lastClaim ? new Date(lastClaim).getTime() : 0;
            const cooldownEndTime = lastClaimTime + cooldownSeconds * 1000;

            if (now < cooldownEndTime) {
                const timeLeftSeconds = Math.floor((cooldownEndTime - now) / 1000);
                const hours = Math.floor(timeLeftSeconds / 3600);
                const minutes = Math.floor((timeLeftSeconds % 3600) / 60);
                const seconds = timeLeftSeconds % 60;
                button.textContent = `${buttonText} (${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')})`;
                button.disabled = true;
            } else {
                button.textContent = buttonText;
                button.disabled = false;
            }
        }

        async function fetchUserInfo() {
            try {
                Telegram.WebApp.sendData(`JS_LOG: Fetching user info for ${userId}`);
                const response = await fetch(`${API_BASE_URL}/get_balance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, username: username })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updateUserInfo(data);
                Telegram.WebApp.sendData(`JS_LOG: User info updated: Balance: ${data.balance}`);
            } catch (error) {
                console.error('Error fetching user info:', error);
                Telegram.WebApp.sendData(`JS_ERROR: Error fetching user info: ${error.message}`);
                // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            }
        }

        // --- –ù–∞–≤—ñ–≥–∞—Ü—ñ—è –º—ñ–∂ —ñ–≥—Ä–∞–º–∏ ---
        gameNavButtons.forEach(button => {
            button.addEventListener('click', () => {
                const game = button.dataset.game;
                gameSections.forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(`${game}-section`).classList.add('active');

                // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ WebSocket –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –∑ –ë–ª–µ–∫–¥–∂–µ–∫—É
                if (blackjackSocket && blackjackSocket.readyState === WebSocket.OPEN) {
                    blackjackSocket.close();
                    blackjackSocket = null; // –û—á–∏—â–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
                    console.log("Blackjack WebSocket closed.");
                }
                // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ WebSocket –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –Ω–∞ –ë–ª–µ–∫–¥–∂–µ–∫
                if (game === 'blackjack') {
                    connectBlackjackWebSocket();
                } else if (game === 'leaderboard') {
                    fetchLeaderboard();
                }
            });
        });

        // --- –°–ª–æ—Ç–∏ ---
        const SLOT_SYMBOLS = ['üçí', 'üçã', 'üçä', 'üçá', 'üîî', 'üíé', 'üçÄ', '‚≠ê', 'üí∞'];
        
        function animateReels() {
            reel1.classList.remove('stop');
            reel2.classList.remove('stop');
            reel3.classList.remove('stop');

            let animationInterval = setInterval(() => {
                reel1.textContent = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
                reel2.textContent = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
                reel3.textContent = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
            }, 100); // –®–≤–∏–¥–∫—ñ—Å—Ç—å –∞–Ω—ñ–º–∞—Ü—ñ—ó

            return animationInterval;
        }

        spinButton.addEventListener('click', async () => {
            spinButton.disabled = true;
            slotMessage.textContent = '–ö—Ä—É—Ç–∏–º–æ...';
            
            // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –±–∞—Ä–∞–±–∞–Ω—ñ–≤
            const animationInterval = animateReels();

            try {
                const response = await fetch(`${API_BASE_URL}/spin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // –ó—É–ø–∏–Ω—è—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É, –∞–ª–µ –ø–µ—Ä–µ–¥ –∑–∞—Ç—Ä–∏–º–∫–æ—é
                clearInterval(animationInterval);
                reel1.classList.add('stop');
                reel2.classList.add('stop');
                reel3.classList.add('stop');
                reel1.textContent = data.symbols[0];
                reel2.textContent = data.symbols[1];
                reel3.textContent = data.symbols[2];
                
                // === –î–û–î–ê–ù–û: –ó–ê—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º UI ===
                await new Promise(resolve => setTimeout(resolve, 1500)); // –ó–∞—Ç—Ä–∏–º–∫–∞ 1.5 —Å–µ–∫—É–Ω–¥–∏

                updateUserInfo(data); // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                slotMessage.textContent = `–í–∏–ø–∞–ª–æ: ${data.symbols.join(' ')}! –í–∏–≥—Ä–∞—à: ${data.winnings} —Ñ–∞–Ω—Ç–∏–∫—ñ–≤. ${data.message || ''}`;
                if (data.winnings > 0) {
                    slotMessage.classList.remove('text-red-400');
                    slotMessage.classList.add('text-green-400');
                } else {
                    slotMessage.classList.remove('text-green-400');
                    slotMessage.classList.add('text-red-400');
                }


            } catch (error) {
                console.error('Error spinning slot:', error);
                slotMessage.textContent = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
                slotMessage.classList.remove('text-green-400');
                slotMessage.classList.add('text-red-400');
            } finally {
                spinButton.disabled = false;
            }
        });

        // --- –ü—ñ–¥–∫–∏–¥–∞–Ω–Ω—è –ú–æ–Ω–µ—Ç–∫–∏ ---
        headsButton.addEventListener('click', () => coinFlipGame('heads'));
        tailsButton.addEventListener('click', () => coinFlipGame('tails'));

        async function coinFlipGame(choice) {
            headsButton.disabled = true;
            tailsButton.disabled = true;
            coinflipMessage.textContent = '–ú–æ–Ω–µ—Ç–∫–∞ –≤ –ø–æ–≤—ñ—Ç—Ä—ñ...';
            coinImage.src = "https://placehold.co/100x100/FFD700/000?text=?"; // –°–∫–∏–¥–∞—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            
            try {
                const response = await fetch(`${API_BASE_URL}/coin_flip`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, choice: choice })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó –º–æ–Ω–µ—Ç–∫–∏
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1 —Å–µ–∫—É–Ω–¥–∞

                const resultText = data.result === 'heads' ? '–û—Ä–µ–ª' : '–†–µ—à–∫–∞';
                coinImage.src = `https://placehold.co/100x100/${data.result === 'heads' ? '00FF00' : 'FF0000'}/FFF?text=${resultText}`;

                updateUserInfo(data);
                coinflipMessage.textContent = data.message;
                if (data.winnings > 0) {
                    coinflipMessage.classList.remove('text-red-400');
                    coinflipMessage.classList.add('text-green-400');
                } else {
                    coinflipMessage.classList.remove('text-green-400');
                    coinflipMessage.classList.add('text-red-400');
                }

            } catch (error) {
                console.error('Error in coin flip:', error);
                coinflipMessage.textContent = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
                coinflipMessage.classList.remove('text-green-400');
                coinflipMessage.classList.add('text-red-400');
            } finally {
                headsButton.disabled = false;
                tailsButton.disabled = false;
            }
        }

        // --- –ë–æ–Ω—É—Å–∏ ---
        dailyBonusBtn.addEventListener('click', async () => {
            dailyBonusBtn.disabled = true;
            try {
                const response = await fetch(`${API_BASE_URL}/claim_daily_bonus`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –±–æ–Ω—É—Å—É');
                }
                
                bonusMessage.textContent = `üéâ –û—Ç—Ä–∏–º–∞–Ω–æ ${data.amount} —â–æ–¥–µ–Ω–Ω–∏—Ö —Ñ–∞–Ω—Ç–∏–∫—ñ–≤!`;
                bonusMessage.classList.remove('text-red-400');
                bonusMessage.classList.add('text-green-300');
                updateUserInfo(data);

            } catch (error) {
                console.error('Error claiming daily bonus:', error);
                bonusMessage.textContent = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
                bonusMessage.classList.remove('text-green-300');
                bonusMessage.classList.add('text-red-400');
            } finally {
                dailyBonusBtn.disabled = false;
            }
        });

        quickBonusBtn.addEventListener('click', async () => {
            quickBonusBtn.disabled = true;
            try {
                const response = await fetch(`${API_BASE_URL}/claim_quick_bonus`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –±–æ–Ω—É—Å—É');
                }
                
                bonusMessage.textContent = `üéâ –û—Ç—Ä–∏–º–∞–Ω–æ ${data.amount} —à–≤–∏–¥–∫–∏—Ö —Ñ–∞–Ω—Ç–∏–∫—ñ–≤!`;
                bonusMessage.classList.remove('text-red-400');
                bonusMessage.classList.add('text-green-300');
                updateUserInfo(data);

            } catch (error) {
                console.error('Error claiming quick bonus:', error);
                bonusMessage.textContent = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
                bonusMessage.classList.remove('text-green-300');
                bonusMessage.classList.add('text-red-400');
            } finally {
                quickBonusBtn.disabled = false;
            }
        });

        // --- –ë–ª–µ–∫–¥–∂–µ–∫ (WebSocket) ---
        function connectBlackjackWebSocket() {
            blackjackStatus.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –≥—Ä–∏...';
            blackjackMessage.textContent = '';
            blackjackBetBtn.disabled = true;
            blackjackHitBtn.disabled = true;
            blackjackStandBtn.disabled = true;
            blackjackBetInput.disabled = true;
            waitingForPlayersText.classList.remove('hidden'); // –ü–æ–∫–∞–∑–∞—Ç–∏ "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤..."
            dealerHandDiv.innerHTML = '';
            dealerScoreP.textContent = '–†–∞—Ö—É–Ω–æ–∫: 0';
            blackjackPlayersDiv.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç–∏ –≥—Ä–∞–≤—Ü—ñ–≤

            // === –í–ò–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω–µ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è WebSocket URL ===
            blackjackSocket = new WebSocket(`${WS_BASE_URL}/${userId}`);
            
            blackjackSocket.onopen = (event) => {
                console.log('WebSocket connection opened:', event);
                blackjackStatus.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ! –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤...';
                // –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞–ø–∏—Ç –Ω–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É –∫—ñ–º–Ω–∞—Ç–∏
                blackjackSocket.send(JSON.stringify({ action: 'request_state' }));
            };

            blackjackSocket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                console.log('WebSocket message received:', msg);
                blackjackMessage.textContent = ''; // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è

                if (msg.type === 'error') {
                    blackjackStatus.textContent = `–ü–æ–º–∏–ª–∫–∞: ${msg.message}`;
                    console.error('Blackjack Error:', msg.message);
                    return;
                }
                
                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –∫—ñ–º–Ω–∞—Ç–∏
                if (msg.room_id) {
                    currentRoomId = msg.room_id;
                    blackjackStatus.textContent = `–ö—ñ–º–Ω–∞—Ç–∞: ${msg.room_id} | –°—Ç–∞—Ç—É—Å: ${msg.status}`;
                    
                    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞–π–º–µ—Ä–∞
                    if (msg.status === 'starting_timer' && msg.timer > 0) {
                        blackjackTimer.classList.remove('hidden');
                        timerCountdown.textContent = msg.timer;
                    } else {
                        blackjackTimer.classList.add('hidden');
                    }

                    // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä—É–∫–∏ –¥–∏–ª–µ—Ä–∞
                    dealerHandDiv.innerHTML = '';
                    if (msg.dealer_hand && msg.dealer_hand.length > 0) {
                        msg.dealer_hand.forEach(cardStr => {
                            const cardDiv = document.createElement('div');
                            cardDiv.className = 'blackjack-card';
                            if (cardStr === 'Hidden') {
                                cardDiv.classList.add('hidden-card');
                                cardDiv.textContent = 'üÇ†'; // –†—É–±–∞—à–∫–∞ –∫–∞—Ä—Ç–∏
                            } else {
                                cardDiv.textContent = cardStr;
                            }
                            dealerHandDiv.appendChild(cardDiv);
                        });
                    }
                    dealerScoreP.textContent = `–†–∞—Ö—É–Ω–æ–∫: ${msg.dealer_score}`;

                    // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤
                    blackjackPlayersDiv.innerHTML = '';
                    if (msg.players && msg.players.length > 0) {
                        waitingForPlayersText.classList.add('hidden'); // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤..."
                        msg.players.forEach(player => {
                            const isCurrentUser = player.user_id == userId; // –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è int –∑ int
                            const playerDiv = document.createElement('div');
                            playerDiv.className = `p-3 rounded-lg flex flex-col items-center shadow ${isCurrentUser ? 'bg-blue-700' : 'bg-gray-700'} ${player.user_id == msg.current_player_turn ? 'border-2 border-yellow-400' : ''}`;
                            
                            let playerHandHtml = '';
                            if (player.hand && player.hand.length > 0) {
                                playerHandHtml = player.hand.map(cardStr => 
                                    `<div class="blackjack-card">${cardStr}</div>`
                                ).join('');
                            } else {
                                playerHandHtml = '–ù–µ–º–∞—î –∫–∞—Ä—Ç';
                            }
                            
                            playerDiv.innerHTML = `
                                <h4 class="font-bold ${isCurrentUser ? 'text-white' : 'text-gray-200'}">${player.username} ${isCurrentUser ? '(–í–∏)' : ''}</h4>
                                <p class="text-sm text-gray-400">–°—Ç–∞–≤–∫–∞: ${player.bet}</p>
                                <div class="flex flex-wrap justify-center my-2">${playerHandHtml}</div>
                                <p class="text-lg ${isCurrentUser ? 'text-yellow-300' : 'text-gray-300'}">–†–∞—Ö—É–Ω–æ–∫: ${player.score}</p>
                                ${player.has_bet ? '<span class="text-xs text-green-300">–°—Ç–∞–≤–∫–∞ –∑—Ä–æ–±–ª–µ–Ω–∞ ‚úÖ</span>' : ''}
                            `;
                            blackjackPlayersDiv.appendChild(playerDiv);
                        });
                    } else {
                        waitingForPlayersText.classList.remove('hidden');
                    }

                    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ –∫–µ—Ä—É–≤–∞–Ω–Ω—è
                    blackjackBetInput.disabled = msg.status !== 'betting';
                    blackjackBetBtn.disabled = msg.status !== 'betting';
                    
                    const isMyTurn = msg.current_player_turn == userId && msg.status === 'playing';
                    blackjackHitBtn.disabled = !isMyTurn;
                    blackjackStandBtn.disabled = !isMyTurn;
                }

                // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥—É
                if (msg.type === 'round_result') {
                    blackjackMessage.textContent = msg.message;
                    if (msg.winnings > 0) {
                        blackjackMessage.classList.remove('text-red-400');
                        blackjackMessage.classList.add('text-green-400');
                    } else {
                        blackjackMessage.classList.remove('text-green-400');
                        blackjackMessage.classList.add('text-red-400');
                    }
                    updateUserInfo(msg); // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É –ø—ñ—Å–ª—è —Ä–∞—É–Ω–¥—É
                } else if (msg.type === 'game_message') {
                     blackjackMessage.textContent = msg.message;
                } else if (msg.type === 'level_up') {
                    Telegram.WebApp.showAlert(`–í—ñ—Ç–∞—î–º–æ! –í–∏ –¥–æ—Å—è–≥–ª–∏ —Ä—ñ–≤–Ω—è ${msg.level}!`);
                }
            };

            blackjackSocket.onclose = (event) => {
                console.log('WebSocket connection closed:', event);
                blackjackStatus.textContent = `–í—ñ–¥–∫–ª—é—á–µ–Ω–æ –≤—ñ–¥ –≥—Ä–∏. –ö–æ–¥: ${event.code}. ${event.reason || '–°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏.'}`;
                blackjackBetBtn.disabled = true;
                blackjackHitBtn.disabled = true;
                blackjackStandBtn.disabled = true;
                blackjackBetInput.disabled = true;
                dealerHandDiv.innerHTML = '–í—ñ–¥–∫–ª—é—á–µ–Ω–æ';
                dealerScoreP.textContent = '–†–∞—Ö—É–Ω–æ–∫: 0';
                blackjackPlayersDiv.innerHTML = '<p class="text-center text-red-400">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ —ñ–Ω—à—É –≤–∫–ª–∞–¥–∫—É —ñ –ø–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è, —â–æ–± —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É.</p>';
                blackjackTimer.classList.add('hidden'); // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Ç–∞–π–º–µ—Ä
            };

            blackjackSocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                blackjackStatus.textContent = '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.';
                Telegram.WebApp.sendData(`JS_ERROR: WebSocket error: ${error.message}`);
            };
        }

        blackjackBetBtn.addEventListener('click', () => {
            const betAmount = parseInt(blackjackBetInput.value);
            if (isNaN(betAmount) || betAmount <= 0) {
                blackjackMessage.textContent = '–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥—ñ–π—Å–Ω—É —Å—É–º—É —Å—Ç–∞–≤–∫–∏.';
                blackjackMessage.classList.add('text-red-400');
                return;
            }
            if (blackjackSocket && blackjackSocket.readyState === WebSocket.OPEN) {
                blackjackSocket.send(JSON.stringify({ action: 'bet', amount: betAmount }));
                blackjackBetBtn.disabled = true; // –í–∏–º–∫–Ω—É—Ç–∏ –∫–Ω–æ–ø–∫—É –ø—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞–≤–∫–∏
                blackjackBetInput.disabled = true;
            }
        });

        blackjackHitBtn.addEventListener('click', () => {
            if (blackjackSocket && blackjackSocket.readyState === WebSocket.OPEN) {
                blackjackSocket.send(JSON.stringify({ action: 'hit' }));
            }
        });

        blackjackStandBtn.addEventListener('click', () => {
            if (blackjackSocket && blackjackSocket.readyState === WebSocket.OPEN) {
                blackjackSocket.send(JSON.stringify({ action: 'stand' }));
            }
        });

        // --- –õ—ñ–¥–µ—Ä–±–æ—Ä–¥ ---
        async function fetchLeaderboard() {
            leaderboardList.innerHTML = '<p class="text-center text-gray-400 flex items-center justify-center gap-2"><div class="spinner"></div> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>';
            try {
                const response = await fetch(`${API_BASE_URL}/get_leaderboard`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}) // –ó–∞–ø–∏—Ç –±–µ–∑ –¥–∞–Ω–∏—Ö, –∞–ª–µ POST
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                leaderboardList.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è–º
                if (data.leaderboard && data.leaderboard.length > 0) {
                    data.leaderboard.forEach((entry, index) => {
                        const rank = index + 1;
                        const rankColor = rank === 1 ? 'text-yellow-400 text-xl' : (rank === 2 ? 'text-gray-300 text-lg' : (rank === 3 ? 'text-orange-300 text-base' : 'text-gray-400'));
                        const entryDiv = document.createElement('div');
                        entryDiv.className = `flex justify-between items-center bg-gray-800 p-2 rounded-md shadow`;
                        entryDiv.innerHTML = `
                            <span class="font-bold ${rankColor}">#${rank} ${entry.username}</span>
                            <span class="text-white">${entry.balance} —Ñ–∞–Ω—Ç–∏–∫—ñ–≤</span>
                            <span class="text-sm text-blue-300">–†—ñ–≤–µ–Ω—å ${entry.level} (XP: ${entry.xp})</span>
                        `;
                        leaderboardList.appendChild(entryDiv);
                    });
                } else {
                    leaderboardList.innerHTML = '<p class="text-center text-gray-400">–î–æ—à–∫–∞ –ª—ñ–¥–µ—Ä—ñ–≤ –ø–æ—Ä–æ–∂–Ω—è.</p>';
                }
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                leaderboardList.innerHTML = `<p class="text-center text-red-400">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª—ñ–¥–µ—Ä–±–æ—Ä–¥—É: ${error.message}</p>`;
            }
        }


        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        document.addEventListener('DOMContentLoaded', async () => {
            if (!Telegram.WebApp.initDataUnsafe || !Telegram.WebApp.initDataUnsafe.user) {
                document.body.innerHTML = '<p class="text-center text-red-500">–¶–µ –¥–æ–¥–∞—Ç–æ–∫ Telegram Mini App. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—ñ–¥–∫—Ä–∏–π—Ç–µ –π–æ–≥–æ —á–µ—Ä–µ–∑ Telegram.</p>';
                return;
            }
            await fetchUserInfo(); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
            // –ó–∞–ø—É—Å–∫–∞—î–º–æ WebSocket –¥–ª—è –ë–ª–µ–∫–¥–∂–µ–∫—É –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ, —è–∫—â–æ —Ü–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ
            // connectBlackjackWebSocket(); // –ó–∞–∫–æ–º–µ–Ω—Ç–æ–≤–∞–Ω–æ, —â–æ–± –ø—ñ–¥–∫–ª—é—á–∞–ª–æ—Å—è —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ë–ª–µ–∫–¥–∂–µ–∫—É
        });

        // –¢–∞–∫–æ–∂ –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —á–µ—Ä–µ–∑ –ø–µ–≤–Ω—ñ –ø—Ä–æ–º—ñ–∂–∫–∏ —á–∞—Å—É,
        // –∞–±–æ –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó –¥—ñ—ó, —è–∫–∞ –∑–º—ñ–Ω—é—î –±–∞–ª–∞–Ω—Å/XP/—Ä—ñ–≤–µ–Ω—å
        // setInterval(fetchUserInfo, 30000); // –û–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –¥–∞–Ω—ñ –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥

    </script>
</body>
</html>